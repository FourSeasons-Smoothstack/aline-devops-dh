pipeline{


agent any

    stages{

        stage('AWS Login'){
            steps{
                withCredentials([usernamePassword(credentialsId: 'aws-cred', passwordVariable: 'AWS_SECRET', usernameVariable: 'AWS_ACCESS')]){
                    sh 'export AWS_ACCESS_KEY_ID=$AWS_ACCESS'
                    sh 'export AWS_SECRET_ACCESS_KEY=$AWS_SECRET'
                    sh 'export AWS_DEFAULT_REGION=us-east-1'
                }
            }
        }

        stage('Terraform Init'){
            steps{
                sh 'terraform init'
            }
        }

        stage('Terraform Plan') {
            steps{
                withAWS(credentials: 'aws-cred-dh', region: 'us-east-1'){
                    
                    sh 'terraform plan'
                }
            }
        }
        stage('Terraform Analysis with Sonarqube'){
            steps{
                script{
                    def scannerHome = tool 'SonarScanner';
                    withSonarQubeEnv('SonarScanner') {
                      sh "${scannerHome}/bin/sonar-scanner"
                    }
                }
                
            }
        }
        stage('Quality Gate'){
            steps{
                withSonarQubeEnv('SonarScanner') {
                    waitForQualityGate abortPipeline: true
                }
            }
        }

        stage('Terraform Apply') {
            steps{
                withAWS(credentials: 'aws-cred-dh', region: 'us-east-1'){
                    
                    sh 'terraform apply -auto-approve'
                }
            }
        }

        stage('Terraform Destroy') {
            steps{
                withAWS(credentials: 'aws-cred-dh', region: 'us-east-1'){
                    
                    sh 'terraform destroy'
                }
            }
        }
    } 
}







