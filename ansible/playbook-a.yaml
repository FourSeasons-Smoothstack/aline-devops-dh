- name: Configure Artifactory
  hosts: artifactory
  become: yes
  gather_facts: false
  tasks:
    - name: Update all packages to their latest version
      ansible.builtin.apt:
        name: "*"
        state: latest

    - name: Install software
      ansible.builtin.apt: 
        name: ['jq', 'wget', 'docker','docker-compose'] 
        state: present

    - name: Start docker daemon
      command: "systemctl start docker.service"

    - name: Download archive
      warn: false
      command: 'wget -O jfrog-compose-installer.tar.gz "https://releases.jfrog.io/artifactory/jfrog-prox/org/artifactory/pro/docker/jfrog-platform-trial-prox/7.41.4/jfrog-platform-trial-prox-7.41.4-compose.tar.gz"'

    - name: Unpack Archive
      ansible.builtin.unarchive:
        src: jfrog-compose-installer.tar.gz
        dest: /

    - name: Run artifactory script
      command: 'jfrog-platform-trial-prox-7.41.4-compose/config.sh'

    - name: Start RabbitMQ
      command: 'docker-compose -p trial-pro-rabbitmq -f jfrog-platform-trial-prox-7.41.4-compose/docker-compose-rabbitmq.yaml up -d'

    - name: Start Artifactory/Xray
      command: 'docker-compose -p trial-pro -f jfrog-platform-trial-prox-7.41.4-compose/docker-compose.yaml up -d'